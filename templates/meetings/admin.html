{% extends "base.html" %}

{% block title %}Administration des réunions - {{ space.name }} — {{ organization.name }}{% endblock %}

{% block meta %}
<link rel="stylesheet" href="{{ url_for('static', filename='refonte.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='proposals.css') }}">
{% endblock %}

{% block content %}
<div class="meetings-admin-layout">
    <div class="container">
        <!-- Header with breadcrumb -->
        <div class="page-header">
            <nav class="breadcrumb">
                <a href="{{ url_for('spaces.index') }}">Espaces participatifs</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{{ url_for('spaces.detail', type=space.type, id=space.id) }}">{{ space.name }}</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{{ url_for('meetings.index', space_id=space.id) }}">Réunions</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Administration</span>
            </nav>
            
            <div class="header-content">
                <h1>
                    <i class="fas fa-cog"></i>
                    Administration des réunions
                </h1>
                <p>Gérez les réunions, modérez le contenu et consultez les statistiques</p>
            </div>
            
            <div class="header-actions">
                <a href="{{ url_for('meetings.create', space_id=space.id) }}" class="btn-refonte btn-refonte-primary">
                    <i class="fas fa-plus"></i>
                    Nouvelle réunion officielle
                </a>
                
                <button class="btn-refonte btn-refonte-outline" onclick="exportMeetingsData()">
                    <i class="fas fa-download"></i>
                    Exporter les données
                </button>
                
                <div class="dropdown">
                    <button class="btn-refonte btn-refonte-outline dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-tools"></i>
                        Actions groupées
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#" onclick="bulkAction('approve')">
                            <i class="fas fa-check"></i>
                            Approuver la sélection
                        </a>
                        <a class="dropdown-item" href="#" onclick="bulkAction('feature')">
                            <i class="fas fa-star"></i>
                            Mettre en avant
                        </a>
                        <a class="dropdown-item" href="#" onclick="bulkAction('archive')">
                            <i class="fas fa-archive"></i>
                            Archiver
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete')">
                            <i class="fas fa-trash"></i>
                            Supprimer
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics dashboard -->
        <div class="admin-dashboard">
            <div class="stats-grid">
                <div class="stat-card card-glass-refonte">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ total_meetings }}</div>
                        <div class="stat-label">Réunions totales</div>
                        <div class="stat-change {{ 'positive' if meetings_growth > 0 else 'negative' if meetings_growth < 0 else '' }}">
                            {% if meetings_growth != 0 %}
                            <i class="fas fa-{{ 'arrow-up' if meetings_growth > 0 else 'arrow-down' }}"></i>
                            {{ meetings_growth }}% ce mois
                            {% else %}
                            Stable
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card card-glass-refonte">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ total_participants }}</div>
                        <div class="stat-label">Participants uniques</div>
                        <div class="stat-change {{ 'positive' if participants_growth > 0 else 'negative' if participants_growth < 0 else '' }}">
                            {% if participants_growth != 0 %}
                            <i class="fas fa-{{ 'arrow-up' if participants_growth > 0 else 'arrow-down' }}"></i>
                            {{ participants_growth }}% ce mois
                            {% else %}
                            Stable
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card card-glass-refonte">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ average_attendance }}%</div>
                        <div class="stat-label">Taux de présence moyen</div>
                        <div class="stat-change">
                            {{ completed_meetings }} réunions terminées
                        </div>
                    </div>
                </div>
                
                <div class="stat-card card-glass-refonte">
                    <div class="stat-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ pending_moderation }}</div>
                        <div class="stat-label">En attente de modération</div>
                        <div class="stat-change">
                            {% if pending_moderation > 0 %}
                            <i class="fas fa-exclamation-circle text-warning"></i>
                            Nécessite une action
                            {% else %}
                            <i class="fas fa-check-circle text-success"></i>
                            Tout à jour
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters and search -->
        <div class="admin-filters card-glass-refonte">
            <div class="filters-row">
                <div class="search-container">
                    <div class="search-input-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="admin-search" class="search-input" 
                               placeholder="Rechercher dans les réunions..." 
                               onkeyup="filterMeetings()">
                        <button class="search-clear" onclick="clearSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="filters-container">
                    <select id="status-filter" onchange="filterMeetings()">
                        <option value="">Tous les statuts</option>
                        <option value="draft">Brouillons</option>
                        <option value="upcoming">À venir</option>
                        <option value="ongoing">En cours</option>
                        <option value="finished">Terminées</option>
                        <option value="cancelled">Annulées</option>
                        <option value="archived">Archivées</option>
                    </select>
                    
                    <select id="type-filter" onchange="filterMeetings()">
                        <option value="">Tous les types</option>
                        <option value="official">Officielles</option>
                        <option value="participant">Participants</option>
                    </select>
                    
                    <select id="moderation-filter" onchange="filterMeetings()">
                        <option value="">Modération</option>
                        <option value="pending">En attente</option>
                        <option value="approved">Approuvées</option>
                        <option value="featured">Mises en avant</option>
                        <option value="reported">Signalées</option>
                    </select>
                    
                    <select id="organizer-filter" onchange="filterMeetings()">
                        <option value="">Tous les organisateurs</option>
                        {% for organizer in organizers %}
                        <option value="{{ organizer.id }}">{{ organizer.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="filters-actions">
                <div class="selected-count">
                    <span id="selected-count">0</span> réunion(s) sélectionnée(s)
                </div>
                
                <div class="view-options">
                    <button class="view-toggle active" data-view="table" onclick="setAdminView('table')">
                        <i class="fas fa-table"></i>
                        Tableau
                    </button>
                    <button class="view-toggle" data-view="cards" onclick="setAdminView('cards')">
                        <i class="fas fa-th-large"></i>
                        Cartes
                    </button>
                </div>
                
                <button class="btn-refonte btn-refonte-outline" onclick="toggleAdvancedFilters()">
                    <i class="fas fa-sliders-h"></i>
                    Filtres avancés
                </button>
            </div>
            
            <!-- Advanced filters -->
            <div id="advanced-filters" class="advanced-filters" style="display: none;">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Période de création</label>
                        <div class="date-range">
                            <input type="date" id="created-from" onchange="filterMeetings()">
                            <span>à</span>
                            <input type="date" id="created-to" onchange="filterMeetings()">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>Période de réunion</label>
                        <div class="date-range">
                            <input type="date" id="meeting-from" onchange="filterMeetings()">
                            <span>à</span>
                            <input type="date" id="meeting-to" onchange="filterMeetings()">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>Participants</label>
                        <div class="range-filter">
                            <input type="number" id="min-participants" placeholder="Min" onchange="filterMeetings()">
                            <span>à</span>
                            <input type="number" id="max-participants" placeholder="Max" onchange="filterMeetings()">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>Options</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="with-minutes" onchange="filterMeetings()">
                                <span class="checkmark"></span>
                                Avec compte-rendu
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="has-reports" onchange="filterMeetings()">
                                <span class="checkmark"></span>
                                Avec signalements
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="online-meetings" onchange="filterMeetings()">
                                <span class="checkmark"></span>
                                Réunions en ligne
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results summary -->
        <div class="results-summary">
            <div class="summary-info">
                <span id="results-count">{{ meetings | length }}</span> réunion{{ 's' if meetings | length != 1 else '' }}
                <span class="summary-separator">•</span>
                <span id="filtered-info">Tous les résultats</span>
            </div>
            
            <div class="sort-options">
                <label>Trier par:</label>
                <select id="sort-by" onchange="sortMeetings()">
                    <option value="created_desc">Plus récentes</option>
                    <option value="created_asc">Plus anciennes</option>
                    <option value="start_time_desc">Date de réunion (desc)</option>
                    <option value="start_time_asc">Date de réunion (asc)</option>
                    <option value="participants_desc">Participants (desc)</option>
                    <option value="participants_asc">Participants (asc)</option>
                    <option value="title_asc">Titre (A-Z)</option>
                    <option value="title_desc">Titre (Z-A)</option>
                </select>
            </div>
        </div>
        
        <!-- Meetings table view -->
        <div id="table-view" class="meetings-table-container">
            <div class="table-responsive">
                <table class="meetings-table">
                    <thead>
                        <tr>
                            <th class="select-column">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <th class="title-column">Titre</th>
                            <th class="organizer-column">Organisateur</th>
                            <th class="date-column">Date</th>
                            <th class="participants-column">Participants</th>
                            <th class="status-column">Statut</th>
                            <th class="moderation-column">Modération</th>
                            <th class="actions-column">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="meetings-table-body">
                        {% for meeting in meetings %}
                        <tr class="meeting-row" data-meeting-id="{{ meeting.id }}" 
                            data-status="{{ meeting.status }}"
                            data-type="{{ meeting.type }}"
                            data-organizer="{{ meeting.organizer.id }}"
                            data-participants="{{ meeting.registrations_count }}"
                            data-created="{{ meeting.created_at.isoformat() }}"
                            data-start="{{ meeting.start_time.isoformat() }}">
                            
                            <td class="select-column">
                                <input type="checkbox" class="meeting-select" value="{{ meeting.id }}" onchange="updateSelectionCount()">
                            </td>
                            
                            <td class="title-column">
                                <div class="meeting-title-cell">
                                    <a href="{{ url_for('meetings.detail', id=meeting.id) }}" class="meeting-title-link">
                                        {{ meeting.title }}
                                    </a>
                                    
                                    <div class="meeting-indicators">
                                        {% if meeting.is_private %}
                                        <span class="indicator private" title="Réunion privée">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        {% endif %}
                                        
                                        {% if meeting.online_meeting_url %}
                                        <span class="indicator online" title="En ligne">
                                            <i class="fas fa-video"></i>
                                        </span>
                                        {% endif %}
                                        
                                        {% if meeting.has_agenda %}
                                        <span class="indicator agenda" title="Avec agenda">
                                            <i class="fas fa-list"></i>
                                        </span>
                                        {% endif %}
                                        
                                        {% if meeting.has_minutes %}
                                        <span class="indicator minutes" title="Avec compte-rendu">
                                            <i class="fas fa-file-alt"></i>
                                        </span>
                                        {% endif %}
                                        
                                        {% if meeting.reports_count > 0 %}
                                        <span class="indicator reported" title="{{ meeting.reports_count }} signalement(s)">
                                            <i class="fas fa-flag"></i>
                                            {{ meeting.reports_count }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            
                            <td class="organizer-column">
                                <div class="organizer-cell">
                                    <div class="organizer-avatar">
                                        {% if meeting.organizer.avatar %}
                                        <img src="{{ meeting.organizer.avatar }}" alt="{{ meeting.organizer.full_name }}">
                                        {% else %}
                                        <div class="avatar-placeholder">{{ meeting.organizer.full_name[:2].upper() }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="organizer-info">
                                        <div class="organizer-name">{{ meeting.organizer.full_name }}</div>
                                        <div class="organizer-role">{{ meeting.organizer.role_in_space(space) }}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="date-column">
                                <div class="date-cell">
                                    <div class="meeting-date">{{ meeting.start_time.strftime('%d %B %Y') }}</div>
                                    <div class="meeting-time">{{ meeting.start_time.strftime('%H:%M') }}</div>
                                    {% if meeting.end_time %}
                                    <div class="meeting-duration">{{ meeting.duration_display }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="participants-column">
                                <div class="participants-cell">
                                    <div class="participants-count">
                                        <i class="fas fa-users"></i>
                                        {{ meeting.registrations_count }}
                                        {% if meeting.registration_limit %}
                                        / {{ meeting.registration_limit }}
                                        {% endif %}
                                    </div>
                                    
                                    {% if meeting.registration_enabled %}
                                    <div class="registration-status">
                                        {% if meeting.can_register_anyone() %}
                                        <span class="status-open">Ouvertes</span>
                                        {% else %}
                                        <span class="status-closed">Fermées</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="status-column">
                                <span class="status-badge status-{{ meeting.status }}">
                                    {% if meeting.status == 'draft' %}
                                    <i class="fas fa-edit"></i> Brouillon
                                    {% elif meeting.status == 'upcoming' %}
                                    <i class="fas fa-clock"></i> À venir
                                    {% elif meeting.status == 'ongoing' %}
                                    <i class="fas fa-play"></i> En cours
                                    {% elif meeting.status == 'finished' %}
                                    <i class="fas fa-check"></i> Terminée
                                    {% elif meeting.status == 'cancelled' %}
                                    <i class="fas fa-times"></i> Annulée
                                    {% elif meeting.status == 'archived' %}
                                    <i class="fas fa-archive"></i> Archivée
                                    {% endif %}
                                </span>
                            </td>
                            
                            <td class="moderation-column">
                                <div class="moderation-cell">
                                    {% if meeting.moderation_status == 'pending' %}
                                    <span class="moderation-badge pending">
                                        <i class="fas fa-hourglass-half"></i>
                                        En attente
                                    </span>
                                    {% elif meeting.moderation_status == 'approved' %}
                                    <span class="moderation-badge approved">
                                        <i class="fas fa-check"></i>
                                        Approuvée
                                    </span>
                                    {% elif meeting.is_featured %}
                                    <span class="moderation-badge featured">
                                        <i class="fas fa-star"></i>
                                        Mise en avant
                                    </span>
                                    {% endif %}
                                    
                                    {% if meeting.reports_count > 0 %}
                                    <button class="reports-btn" onclick="showReports({{ meeting.id }})" title="Voir les signalements">
                                        <i class="fas fa-flag"></i>
                                        {{ meeting.reports_count }}
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="actions-column">
                                <div class="action-buttons">
                                    <a href="{{ url_for('meetings.detail', id=meeting.id) }}" class="action-btn" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <a href="{{ url_for('meetings.edit', id=meeting.id) }}" class="action-btn" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    
                                    <div class="dropdown">
                                        <button class="action-btn dropdown-toggle" data-toggle="dropdown" title="Plus d'actions">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            {% if meeting.moderation_status == 'pending' %}
                                            <a class="dropdown-item" href="#" onclick="moderateMeeting({{ meeting.id }}, 'approve')">
                                                <i class="fas fa-check"></i>
                                                Approuver
                                            </a>
                                            {% endif %}
                                            
                                            <a class="dropdown-item" href="#" onclick="moderateMeeting({{ meeting.id }}, 'feature')">
                                                <i class="fas fa-star"></i>
                                                {{ 'Retirer la mise en avant' if meeting.is_featured else 'Mettre en avant' }}
                                            </a>
                                            
                                            {% if meeting.status in ['upcoming', 'ongoing'] %}
                                            <a class="dropdown-item" href="#" onclick="moderateMeeting({{ meeting.id }}, 'cancel')">
                                                <i class="fas fa-ban"></i>
                                                Annuler
                                            </a>
                                            {% endif %}
                                            
                                            {% if meeting.status == 'finished' %}
                                            <a class="dropdown-item" href="#" onclick="moderateMeeting({{ meeting.id }}, 'archive')">
                                                <i class="fas fa-archive"></i>
                                                Archiver
                                            </a>
                                            {% endif %}
                                            
                                            <div class="dropdown-divider"></div>
                                            
                                            <a class="dropdown-item" href="#" onclick="exportMeetingData({{ meeting.id }})">
                                                <i class="fas fa-download"></i>
                                                Exporter les données
                                            </a>
                                            
                                            <a class="dropdown-item" href="#" onclick="duplicateMeeting({{ meeting.id }})">
                                                <i class="fas fa-copy"></i>
                                                Dupliquer
                                            </a>
                                            
                                            <div class="dropdown-divider"></div>
                                            
                                            <a class="dropdown-item text-danger" href="#" onclick="deleteMeeting({{ meeting.id }})">
                                                <i class="fas fa-trash"></i>
                                                Supprimer
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Meetings cards view -->
        <div id="cards-view" class="meetings-cards-container" style="display: none;">
            <div class="cards-grid">
                {% for meeting in meetings %}
                <div class="meeting-admin-card card-glass-refonte" data-meeting-id="{{ meeting.id }}">
                    <div class="card-header">
                        <div class="card-select">
                            <input type="checkbox" class="meeting-select" value="{{ meeting.id }}" onchange="updateSelectionCount()">
                        </div>
                        
                        <div class="card-status">
                            <span class="status-badge status-{{ meeting.status }}">
                                {{ meeting.status_display }}
                            </span>
                            
                            {% if meeting.is_featured %}
                            <span class="featured-badge">
                                <i class="fas fa-star"></i>
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="card-actions">
                            <div class="dropdown">
                                <button class="action-btn dropdown-toggle" data-toggle="dropdown">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <!-- Same dropdown items as table view -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <h3 class="card-title">
                            <a href="{{ url_for('meetings.detail', id=meeting.id) }}">{{ meeting.title }}</a>
                        </h3>
                        
                        <div class="card-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                {{ meeting.start_time.strftime('%d %B %Y à %H:%M') }}
                            </div>
                            
                            <div class="meta-item">
                                <i class="fas fa-user"></i>
                                {{ meeting.organizer.full_name }}
                            </div>
                            
                            <div class="meta-item">
                                <i class="fas fa-users"></i>
                                {{ meeting.registrations_count }} participant{{ 's' if meeting.registrations_count != 1 else '' }}
                            </div>
                        </div>
                        
                        <div class="card-indicators">
                            {% if meeting.is_private %}
                            <span class="indicator private"><i class="fas fa-lock"></i></span>
                            {% endif %}
                            {% if meeting.online_meeting_url %}
                            <span class="indicator online"><i class="fas fa-video"></i></span>
                            {% endif %}
                            {% if meeting.has_minutes %}
                            <span class="indicator minutes"><i class="fas fa-file-alt"></i></span>
                            {% endif %}
                            {% if meeting.reports_count > 0 %}
                            <span class="indicator reported"><i class="fas fa-flag"></i> {{ meeting.reports_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="moderation-status">
                            {% if meeting.moderation_status == 'pending' %}
                            <span class="badge pending">En attente de modération</span>
                            {% elif meeting.moderation_status == 'approved' %}
                            <span class="badge approved">Approuvée</span>
                            {% endif %}
                        </div>
                        
                        <div class="quick-actions">
                            <a href="{{ url_for('meetings.detail', id=meeting.id) }}" class="btn-refonte btn-refonte-outline btn-sm">
                                Voir
                            </a>
                            <a href="{{ url_for('meetings.edit', id=meeting.id) }}" class="btn-refonte btn-refonte-outline btn-sm">
                                Modifier
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Empty state -->
        {% if not meetings %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>Aucune réunion trouvée</h3>
            <p>Il n'y a pas encore de réunions correspondant à vos critères.</p>
            <a href="{{ url_for('meetings.create', space_id=space.id) }}" class="btn-refonte btn-refonte-primary">
                <i class="fas fa-plus"></i>
                Créer la première réunion
            </a>
        </div>
        {% endif %}
        
        <!-- Pagination -->
        {% if meetings | length >= 50 %}
        <div class="pagination-container">
            <nav class="pagination">
                <!-- Pagination controls -->
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Reports Modal -->
<div id="reports-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Signalements de la réunion</h3>
            <button class="modal-close" onclick="closeReportsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="reports-content">
                <!-- Reports content will be loaded here -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-refonte btn-refonte-secondary" onclick="closeReportsModal()">
                Fermer
            </button>
            
            <button class="btn-refonte btn-refonte-danger" onclick="handleReports('dismiss')">
                <i class="fas fa-times"></i>
                Rejeter tous les signalements
            </button>
            
            <button class="btn-refonte btn-refonte-warning" onclick="handleReports('action')">
                <i class="fas fa-exclamation-triangle"></i>
                Prendre une mesure
            </button>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div id="bulk-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="bulk-modal-title">Action groupée</h3>
            <button class="modal-close" onclick="closeBulkModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="bulk-modal-content">
                <!-- Bulk action content -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-refonte btn-refonte-secondary" onclick="closeBulkModal()">
                Annuler
            </button>
            
            <button class="btn-refonte btn-refonte-primary" onclick="confirmBulkAction()" id="confirm-bulk-btn">
                Confirmer
            </button>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedMeetings = [];
let currentView = 'table';
let currentSort = 'created_desc';

document.addEventListener('DOMContentLoaded', function() {
    // Initialize view from localStorage
    const savedView = localStorage.getItem('admin-meetings-view');
    if (savedView) {
        setAdminView(savedView);
    }
    
    // Initialize sort from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sortParam = urlParams.get('sort');
    if (sortParam) {
        document.getElementById('sort-by').value = sortParam;
        currentSort = sortParam;
    }
    
    // Apply initial filters
    filterMeetings();
});

// View switching
function setAdminView(view) {
    currentView = view;
    
    const tableView = document.getElementById('table-view');
    const cardsView = document.getElementById('cards-view');
    const toggles = document.querySelectorAll('.view-toggle');
    
    // Update toggles
    toggles.forEach(toggle => {
        toggle.classList.toggle('active', toggle.dataset.view === view);
    });
    
    // Update views
    if (view === 'table') {
        tableView.style.display = 'block';
        cardsView.style.display = 'none';
    } else {
        tableView.style.display = 'none';
        cardsView.style.display = 'block';
    }
    
    // Save preference
    localStorage.setItem('admin-meetings-view', view);
}

// Selection management
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.meeting-select');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectionCount();
}

function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('.meeting-select:checked');
    selectedMeetings = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('selected-count').textContent = selectedMeetings.length;
    
    // Update select all checkbox
    const selectAll = document.getElementById('select-all');
    const totalCheckboxes = document.querySelectorAll('.meeting-select').length;
    
    if (selectedMeetings.length === 0) {
        selectAll.indeterminate = false;
        selectAll.checked = false;
    } else if (selectedMeetings.length === totalCheckboxes) {
        selectAll.indeterminate = false;
        selectAll.checked = true;
    } else {
        selectAll.indeterminate = true;
        selectAll.checked = false;
    }
}

// Filtering functionality
function filterMeetings() {
    const searchTerm = document.getElementById('admin-search').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const moderationFilter = document.getElementById('moderation-filter').value;
    const organizerFilter = document.getElementById('organizer-filter').value;
    
    // Advanced filters
    const createdFrom = document.getElementById('created-from')?.value;
    const createdTo = document.getElementById('created-to')?.value;
    const meetingFrom = document.getElementById('meeting-from')?.value;
    const meetingTo = document.getElementById('meeting-to')?.value;
    const minParticipants = document.getElementById('min-participants')?.value;
    const maxParticipants = document.getElementById('max-participants')?.value;
    const withMinutes = document.getElementById('with-minutes')?.checked;
    const hasReports = document.getElementById('has-reports')?.checked;
    const onlineMeetings = document.getElementById('online-meetings')?.checked;
    
    const meetings = document.querySelectorAll('.meeting-row, .meeting-admin-card');
    let visibleCount = 0;
    
    meetings.forEach(meeting => {
        let visible = true;
        
        // Search filter
        if (searchTerm) {
            const title = meeting.querySelector('.meeting-title-link, .card-title a').textContent.toLowerCase();
            visible = visible && title.includes(searchTerm);
        }
        
        // Status filter
        if (statusFilter) {
            visible = visible && meeting.dataset.status === statusFilter;
        }
        
        // Type filter
        if (typeFilter) {
            visible = visible && meeting.dataset.type === typeFilter;
        }
        
        // Organizer filter
        if (organizerFilter) {
            visible = visible && meeting.dataset.organizer === organizerFilter;
        }
        
        // Moderation filter
        if (moderationFilter) {
            const hasPending = meeting.querySelector('.moderation-badge.pending');
            const hasApproved = meeting.querySelector('.moderation-badge.approved');
            const hasFeatured = meeting.querySelector('.moderation-badge.featured');
            const hasReported = meeting.querySelector('.indicator.reported');
            
            switch (moderationFilter) {
                case 'pending':
                    visible = visible && hasPending;
                    break;
                case 'approved':
                    visible = visible && hasApproved;
                    break;
                case 'featured':
                    visible = visible && hasFeatured;
                    break;
                case 'reported':
                    visible = visible && hasReported;
                    break;
            }
        }
        
        // Date filters
        if (createdFrom || createdTo) {
            const createdDate = new Date(meeting.dataset.created);
            if (createdFrom && createdDate < new Date(createdFrom)) visible = false;
            if (createdTo && createdDate > new Date(createdTo)) visible = false;
        }
        
        if (meetingFrom || meetingTo) {
            const meetingDate = new Date(meeting.dataset.start);
            if (meetingFrom && meetingDate < new Date(meetingFrom)) visible = false;
            if (meetingTo && meetingDate > new Date(meetingTo)) visible = false;
        }
        
        // Participants filter
        if (minParticipants || maxParticipants) {
            const participants = parseInt(meeting.dataset.participants);
            if (minParticipants && participants < parseInt(minParticipants)) visible = false;
            if (maxParticipants && participants > parseInt(maxParticipants)) visible = false;
        }
        
        // Options filters
        if (withMinutes) {
            visible = visible && meeting.querySelector('.indicator.minutes');
        }
        
        if (hasReports) {
            visible = visible && meeting.querySelector('.indicator.reported');
        }
        
        if (onlineMeetings) {
            visible = visible && meeting.querySelector('.indicator.online');
        }
        
        // Show/hide meeting
        meeting.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update counter
    document.getElementById('results-count').textContent = visibleCount;
    
    // Update filtered info
    const totalMeetings = meetings.length;
    const filteredInfo = document.getElementById('filtered-info');
    if (visibleCount === totalMeetings) {
        filteredInfo.textContent = 'Tous les résultats';
    } else {
        filteredInfo.textContent = `${visibleCount} sur ${totalMeetings}`;
    }
    
    // Update search clear button
    const clearButton = document.querySelector('.search-clear');
    clearButton.style.display = searchTerm ? 'block' : 'none';
}

function clearSearch() {
    document.getElementById('admin-search').value = '';
    filterMeetings();
}

function toggleAdvancedFilters() {
    const advancedFilters = document.getElementById('advanced-filters');
    const button = event.target.closest('button');
    
    if (advancedFilters.style.display === 'none') {
        advancedFilters.style.display = 'block';
        button.innerHTML = '<i class="fas fa-sliders-h"></i> Masquer les filtres';
    } else {
        advancedFilters.style.display = 'none';
        button.innerHTML = '<i class="fas fa-sliders-h"></i> Filtres avancés';
    }
}

// Sorting functionality
function sortMeetings() {
    const sortBy = document.getElementById('sort-by').value;
    currentSort = sortBy;
    
    const container = currentView === 'table' ? 
        document.getElementById('meetings-table-body') : 
        document.querySelector('.cards-grid');
    
    const meetings = Array.from(container.children);
    
    meetings.sort((a, b) => {
        let valueA, valueB;
        
        switch (sortBy) {
            case 'created_desc':
            case 'created_asc':
                valueA = new Date(a.dataset.created);
                valueB = new Date(b.dataset.created);
                break;
                
            case 'start_time_desc':
            case 'start_time_asc':
                valueA = new Date(a.dataset.start);
                valueB = new Date(b.dataset.start);
                break;
                
            case 'participants_desc':
            case 'participants_asc':
                valueA = parseInt(a.dataset.participants);
                valueB = parseInt(b.dataset.participants);
                break;
                
            case 'title_asc':
            case 'title_desc':
                valueA = a.querySelector('.meeting-title-link, .card-title a').textContent.toLowerCase();
                valueB = b.querySelector('.meeting-title-link, .card-title a').textContent.toLowerCase();
                break;
        }
        
        if (sortBy.endsWith('_desc')) {
            return valueB > valueA ? 1 : valueB < valueA ? -1 : 0;
        } else {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        }
    });
    
    // Reorder DOM elements
    meetings.forEach(meeting => container.appendChild(meeting));
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    window.history.replaceState({}, '', url);
}

// Moderation actions
function moderateMeeting(meetingId, action) {
    let confirmMessage = '';
    
    switch (action) {
        case 'approve':
            confirmMessage = 'Approuver cette réunion ?';
            break;
        case 'feature':
            confirmMessage = 'Modifier la mise en avant de cette réunion ?';
            break;
        case 'cancel':
            confirmMessage = 'Annuler cette réunion ? Les participants seront notifiés.';
            break;
        case 'archive':
            confirmMessage = 'Archiver cette réunion ?';
            break;
    }
    
    if (confirm(confirmMessage)) {
        fetch(`/api/meetings/${meetingId}/moderate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Erreur lors de la modération');
            }
        });
    }
}

function deleteMeeting(meetingId) {
    if (!confirm('Supprimer définitivement cette réunion ? Cette action est irréversible.')) return;
    
    fetch(`/api/meetings/${meetingId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-meeting-id="${meetingId}"]`).remove();
            filterMeetings(); // Update counters
        } else {
            alert(data.message || 'Erreur lors de la suppression');
        }
    });
}

// Bulk actions
function bulkAction(action) {
    if (selectedMeetings.length === 0) {
        alert('Veuillez sélectionner au moins une réunion.');
        return;
    }
    
    const modal = document.getElementById('bulk-modal');
    const title = document.getElementById('bulk-modal-title');
    const content = document.getElementById('bulk-modal-content');
    const confirmBtn = document.getElementById('confirm-bulk-btn');
    
    let actionText = '';
    let contentHtml = '';
    
    switch (action) {
        case 'approve':
            actionText = 'Approuver les réunions sélectionnées';
            contentHtml = `
                <p>Vous allez approuver ${selectedMeetings.length} réunion(s) sélectionnée(s).</p>
                <p>Cette action rendra les réunions visibles publiquement.</p>
            `;
            confirmBtn.className = 'btn-refonte btn-refonte-success';
            break;
            
        case 'feature':
            actionText = 'Mettre en avant les réunions sélectionnées';
            contentHtml = `
                <p>Vous allez mettre en avant ${selectedMeetings.length} réunion(s) sélectionnée(s).</p>
                <p>Ces réunions apparaîtront en priorité dans les listes.</p>
            `;
            confirmBtn.className = 'btn-refonte btn-refonte-primary';
            break;
            
        case 'archive':
            actionText = 'Archiver les réunions sélectionnées';
            contentHtml = `
                <p>Vous allez archiver ${selectedMeetings.length} réunion(s) sélectionnée(s).</p>
                <p>Les réunions archivées ne seront plus visibles publiquement.</p>
            `;
            confirmBtn.className = 'btn-refonte btn-refonte-warning';
            break;
            
        case 'delete':
            actionText = 'Supprimer les réunions sélectionnées';
            contentHtml = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Attention !</strong> Cette action est irréversible.
                </div>
                <p>Vous allez supprimer définitivement ${selectedMeetings.length} réunion(s) sélectionnée(s).</p>
                <p>Toutes les données associées (participants, commentaires, etc.) seront perdues.</p>
            `;
            confirmBtn.className = 'btn-refonte btn-refonte-danger';
            break;
    }
    
    title.textContent = actionText;
    content.innerHTML = contentHtml;
    confirmBtn.dataset.action = action;
    
    modal.style.display = 'flex';
}

function confirmBulkAction() {
    const action = document.getElementById('confirm-bulk-btn').dataset.action;
    const button = document.getElementById('confirm-bulk-btn');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    
    fetch('/api/meetings/bulk-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: action,
            meeting_ids: selectedMeetings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeBulkModal();
            location.reload();
        } else {
            alert(data.message || 'Erreur lors de l\'action groupée');
            button.disabled = false;
            button.innerHTML = 'Confirmer';
        }
    });
}

function closeBulkModal() {
    document.getElementById('bulk-modal').style.display = 'none';
}

// Reports management
function showReports(meetingId) {
    fetch(`/api/meetings/${meetingId}/reports`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('reports-content').innerHTML = data.html;
            document.getElementById('reports-modal').style.display = 'flex';
            document.getElementById('reports-modal').dataset.meetingId = meetingId;
        }
    });
}

function closeReportsModal() {
    document.getElementById('reports-modal').style.display = 'none';
}

function handleReports(action) {
    const meetingId = document.getElementById('reports-modal').dataset.meetingId;
    
    fetch(`/api/meetings/${meetingId}/reports/handle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeReportsModal();
            location.reload();
        }
    });
}

// Export functionality
function exportMeetingsData() {
    const params = new URLSearchParams();
    
    // Add current filters
    if (document.getElementById('status-filter').value) {
        params.set('status', document.getElementById('status-filter').value);
    }
    if (document.getElementById('type-filter').value) {
        params.set('type', document.getElementById('type-filter').value);
    }
    
    window.open(`/api/meetings/export.csv?${params.toString()}`, '_blank');
}

function exportMeetingData(meetingId) {
    window.open(`/api/meetings/${meetingId}/export.csv`, '_blank');
}

// Duplication
function duplicateMeeting(meetingId) {
    if (confirm('Dupliquer cette réunion ?')) {
        fetch(`/api/meetings/${meetingId}/duplicate`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.edit_url;
            }
        });
    }
}

// Search input enhancements
document.getElementById('admin-search').addEventListener('input', function() {
    const clearButton = document.querySelector('.search-clear');
    clearButton.style.display = this.value ? 'block' : 'none';
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K for search focus
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('admin-search').focus();
    }
    
    // Ctrl/Cmd + A for select all
    if ((e.ctrlKey || e.metaKey) && e.key === 'a' && !document.activeElement.matches('input, textarea')) {
        e.preventDefault();
        document.getElementById('select-all').click();
    }
    
    // Delete key for bulk delete
    if (e.key === 'Delete' && selectedMeetings.length > 0 && !document.activeElement.matches('input, textarea')) {
        e.preventDefault();
        bulkAction('delete');
    }
});
</script>
{% endblock %}
